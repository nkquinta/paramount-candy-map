<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paramount, CA â€” Candy Houses Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: .75rem 1rem; background: #0f172a; color: #fff; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }
    header .actions { margin-left: auto; display: flex; gap: .5rem; }
    button { cursor: pointer; border: 0; padding: .6rem .9rem; border-radius: 12px; background: #10b981; color: white; font-weight: 700; }
    button.secondary { background: #334155; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #map { width: 100%; height: 100%; }
    .legend { position: absolute; z-index: 500; bottom: 16px; left: 12px; background: rgba(255,255,255,.95); padding: .5rem .75rem; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,.15); font-size: .9rem; }
    .notice { background: #fffbeb; border: 1px solid #fde68a; color: #713f12; padding: .5rem .75rem; border-radius: 10px; }
    .popup-form label { display:block; font-size:.85rem; margin:.35rem 0 .2rem; }
    .popup-form input, .popup-form textarea { width: 100%; padding:.5rem; border-radius:8px; border:1px solid #cbd5e1; }
    .popup-form small { display:block; color:#64748b; margin-top:.25rem; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Paramount, CA â€” Candy Houses ðŸŽƒ</h1>
      <div class="actions">
        <button id="addBtn">Add my candy house</button>
        <button id="resetBtn" class="secondary" title="Zoom back to Paramount">Reset view</button>
      </div>
    </header>
    <div id="map"></div>
    <div class="legend">
      <div><strong>How it works</strong></div>
      <div>â€¢ Tap <em>Add my candy house</em>, then click your spot on the map.</div>
      <div>â€¢ We gently offset the pin ~30m for privacy (donâ€™t share your exact number).</div>
      <div>â€¢ Only Paramount, CA locations are allowed.</div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Firebase v10 (module) -->
  <script type="module">
    // === 1) Replace with your Firebase web app config ===
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // === 2) City settings (Paramount, CA) ===
    const CITY_CENTER = [33.8895, -118.1598];
    const CITY_BOUNDS = L.latLngBounds(
      [33.8617, -118.1918], // SW approx
      [33.9139, -118.1270]  // NE approx
    );

    // â€”â€”â€” Map setup â€”â€”â€”
    const map = L.map('map', { maxBounds: CITY_BOUNDS.pad(0.05), maxBoundsViscosity: 0.8 }).setView(CITY_CENTER, 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const addBtn = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');

    resetBtn.addEventListener('click', () => map.fitBounds(CITY_BOUNDS));

    // â€”â€”â€” Privacy: jitter a lat/lng by ~30 meters â€”â€”â€”
    function jitterLatLng(lat, lng, meters = 30) {
      const rnd = () => (Math.random() - 0.5) * 2; // -1..1
      const dLat = (meters / 111111) * rnd();
      const dLng = (meters / (111111 * Math.cos(lat * Math.PI/180))) * rnd();
      return [lat + dLat, lng + dLng];
    }

    // â€”â€”â€” Firebase init & Anonymous auth â€”â€”â€”
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Sign in (anonymous)
    await signInAnonymously(auth);

    // Realtime listener for all candy houses
    const markersLayer = L.layerGroup().addTo(map);
    const q = query(collection(db, 'houses'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      markersLayer.clearLayers();
      snapshot.forEach((doc) => {
        const d = doc.data();
        if (!d || !d.lat || !d.lng) return;
        // Constrain display within the city bounds
        const latlng = L.latLng(d.lat, d.lng);
        if (!CITY_BOUNDS.contains(latlng)) return;
        const id = doc.id;
        const marker = L.marker(latlng).addTo(markersLayer);
        const safeNote = (d.note || '').replace(/[<>]/g, '');
        const isOwner = (auth.currentUser && d.uid === auth.currentUser.uid);
        const popupHtml = `
          <div>
            <strong>Candy here!</strong><br>${safeNote ? safeNote : 'Happy Halloween! ðŸŽƒ'}
            ${isOwner ? `<div style="margin-top:.5rem; display:flex; gap:.5rem;">
              <button class="secondary" data-del="${id}">Delete my pin</button>
            </div>
            <small>Use this if you tapped the wrong spot or need to fix your note. You can add again afterwards.</small>` : ''}
          </div>`;
        marker.bindPopup(popupHtml);
        marker.on('popupopen', () => {
          const btn = document.querySelector(`button[data-del="${id}"]`);
          if (!btn) return;
          btn.addEventListener('click', async () => {
            try {
              await deleteDoc(doc(db, 'houses', id));
              map.closePopup();
              alert('Deleted. You can add a new pin.');
            } catch (err) {
              console.error(err);
              alert('Delete failed: ' + err.message);
            }
          }, { once: true });
        });
      });
    });

    // Add new house flow
    let addMode = false;
    addBtn.addEventListener('click', () => {
      addMode = true;
      addBtn.disabled = true;
      const notice = L.control({position: 'topright'});
      notice.onAdd = () => {
        const div = L.DomUtil.create('div', 'notice');
        div.innerHTML = '<strong>Add mode:</strong> click your spot on the map to place a pin. (We will offset ~30m)';
        return div;
      };
      notice.addTo(map);

      const clickOnce = async (e) => {
        if (!addMode) return;
        addMode = false;
        addBtn.disabled = false;
        map.off('click', clickOnce);
        // Remove all notices
        document.querySelectorAll('.notice').forEach(n => n.remove());

        // Prevent out-of-bounds submissions
        if (!CITY_BOUNDS.contains(e.latlng)) {
          alert('Please pick a spot within Paramount, CA.');
          return;
        }

        const [jLat, jLng] = jitterLatLng(e.latlng.lat, e.latlng.lng, 30);

        // Build a small popup form
        const popup = L.popup()
          .setLatLng(e.latlng)
          .setContent(`
            <div class="popup-form">
              <label>Optional note</label>
              <textarea id="note" rows="2" placeholder="e.g., \"Full-size bars!\" or \"Open 6â€“9pm\""></textarea>
              <small>We will offset the saved pin ~30m for privacy.</small>
              <div style="display:flex; gap:.5rem; margin-top:.5rem;">
                <button id="savePin">Save</button>
                <button id="cancelPin" class="secondary">Cancel</button>
              </div>
            </div>
          `)
          .openOn(map);

        const saveBtn = document.getElementById('savePin');
        const cancelBtn = document.getElementById('cancelPin');
        const noteEl = document.getElementById('note');

        cancelBtn.addEventListener('click', () => map.closePopup(popup));
        saveBtn.addEventListener('click', async () => {
          saveBtn.disabled = true;
          try {
            await addDoc(collection(db, 'houses'), {
              lat: jLat,
              lng: jLng,
              note: (noteEl.value || '').slice(0, 200),
              uid: auth.currentUser ? auth.currentUser.uid : null,
              createdAt: serverTimestamp()
            });
            map.closePopup(popup);
            alert('Thanks! Your house has been added.');
          } catch (err) {
            console.error(err);
            alert('Sorry, something went wrong. Try again.');
            saveBtn.disabled = false;
          }
        });
      };

      map.on('click', clickOnce);
    });

    // Keep map inside bounds and start there
    map.fitBounds(CITY_BOUNDS);
  </script>
</body>
</html>
